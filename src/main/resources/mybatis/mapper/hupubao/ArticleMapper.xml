<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="win.hupubao.mapper.hupubao.ArticleMapper" >

	<sql id="conditions">
		<where>
			<if test="@win.hupubao.common.utils.StringUtils@isNotBlank(title)" >
				and title like '%' || #{title, jdbcType=VARCHAR} || '%'
			</if>

			<if test="@win.hupubao.common.utils.StringUtils@isNotBlank(categoryId)">
				and category_id = #{categoryId, jdbcType=VARCHAR}
			</if>

			<if test="@win.hupubao.common.utils.StringUtils@isNotBlank(category)">
				and c.name = #{category, jdbcType=VARCHAR}
			</if>

            <if test="@win.hupubao.common.utils.StringUtils@isNotBlank(tagId)">
                and at.tag_id = #{tagId, jdbcType=VARCHAR}
            </if>
            <if test="@win.hupubao.common.utils.StringUtils@isNotBlank(status)">
                and `status` = #{status, jdbcType=INTEGER}
            </if>
		</where>
	</sql>

	<resultMap id="articleListMap" type="win.hupubao.beans.biz.ArticleBean">
		<id column="id" property="id"/>
		<result column="creator" property="creator"/>
		<result column="title" property="title"/>
		<result column="category_id" property="categoryId"/>
		<result column="create_time" property="createTime"/>
		<result column="last_update_date" property="lastUpdateDate"/>
		<result column="type" property="type"/>
		<result column="status" property="status"/>
		<result column="category" property="category"/>
		<result column="tags" property="tags"/>
		<result column="intro" property="intro"/>
		<collection property="tagList" javaType="java.util.List" resultMap="tagMap">
		</collection>
	</resultMap>

	<resultMap id="articleMap" extends="articleListMap"
			   type="win.hupubao.beans.biz.ArticleBean">
		<result column="context" property="context"/>
	</resultMap>

	<resultMap id="tagMap" type="win.hupubao.beans.biz.TagBean">
		<id column="tag_id" property="id"/>
		<result column="tag_name" property="name"/>
		<result column="tag_create_time" property="createTime"/>
	</resultMap>


	<select id="selectList"
			parameterType="win.hupubao.beans.biz.ArticleBean"
			resultMap="articleListMap">
		select
			a.*,
			c.name as category,
			GROUP_CONCAT(t.name, ',') as tags

		from article a
			left join category c on a.category_id = c.id
			left join article_tag at on a.id = at.article_id
			left join tag t on at.tag_id = t.id
		<include refid="conditions"/>
		group by a.id
	</select>

	<select id="selectArticleDetail"
			parameterType="java.lang.String"
			resultMap="articleMap">
		select
			a.*,
			c.name as category,
			t.id as tag_id,
			t.name as tag_name,
			t.create_time as tag_create_time
		from article a
			left join article_tag at on a.id = at.article_id
			left join tag t on at.tag_id = t.id
			left join category c on a.category_id = c.id
		where a.id = #{id, jdbcType=VARCHAR}
	</select>
</mapper>